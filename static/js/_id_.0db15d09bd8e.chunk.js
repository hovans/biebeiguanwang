import{n as y,a9 as L,r as l,ar as T,j as r,aI as s,i as f,bA as M,bQ as G,bR as H,bS as Q,ah as N,T as S,aj as R,bT as j,F as B,av as W,ai as q,bP as $,bl as z,bm as U,a7 as Y,bn as V,bU as J,bo as K,bh as E,a$ as I,bV as X,H as Z,af as P,p as F,v as A,as as ee,bL as re}from"./vendor.7b4e3a5ce4ba.chunk.js";import{v as te,w as ce,x as ne,M as _,m as O,t as oe,A as D,y as ae,b as ie}from"./index.44dd358e3964.js";import{c as se}from"./constate.es.00b696db87ce.chunk.js";import{O as d}from"./order.269a0794995b.chunk.js";import{a as x}from"./plan.853c03fa5fdd.chunk.js";const de=({tradeNo:t})=>{var g;const{t:e}=y(),{enqueueSnackbar:a}=L(),[n,i]=l.useState(d.PENDING),[o,p]=l.useState(!1),u=te(t),h=ce(t,{skip:n!==d.PENDING&&n!==d.PAID||!u.isSuccess,pollingInterval:1e3}),b=ne(void 0,{skip:n!==d.PENDING||!u.isSuccess}),[v,c]=l.useState(0),m=l.useMemo(()=>{var k;return new Map((k=b.data)==null?void 0:k.map(w=>[w.id,w]))},[b.data]);return l.useEffect(()=>{v===0&&b.isSuccess&&c(b.data[0].id)},[b.isSuccess,v,b.data]),l.useEffect(()=>{var k;(k=u.data)!=null&&k.status&&i(u.data.status)},[(g=u.data)==null?void 0:g.status]),l.useEffect(()=>{h.data&&i(h.data)},[h.data]),l.useEffect(()=>{u.error&&a(e("notice::order-detail-error",{error:u.error.message}),{variant:"error"})},[u.error]),{tradeNo:t,status:n,detail:u,callback:h,paymentMethod:b,paymentMethodIndex:m,paymentMethodState:v,setPaymentMethodState:c,isSubmitting:o,setSubmitting:p}},[le,C]=se(de),ue=()=>{const{t}=y(),{detail:{data:e,isLoading:a}}=C(),n=l.useMemo(()=>{const o=T.unix((e==null?void 0:e.created_at)||0);switch(e==null?void 0:e.period){case x.MONTHLY:return o.add(1,"month");case x.QUARTERLY:return o.add(3,"month");case x.HALF_YEARLY:return o.add(6,"month");case x.YEARLY:return o.add(1,"year");case x.TWO_YEARLY:return o.add(2,"year");default:return o}},[e==null?void 0:e.created_at,e==null?void 0:e.period]),i=l.useMemo(()=>[{label:t("order.checkout.product-info-card.product-name"),value:e==null?void 0:e.plan.name},{label:t("order.checkout.product-info-card.product-type"),value:t("order.checkout.product-info-card.product-period",{context:e==null?void 0:e.period})},{label:t("order.checkout.product-info-card.traffic"),value:t("order.checkout.product-info-card.traffic",{count:(e==null?void 0:e.plan.transfer_enable)||0,context:(e==null?void 0:e.plan.transfer_enable)===null?"unlimited":"limited"})},...(e==null?void 0:e.period)===x.ONETIME?[]:[{label:t("order.checkout.product-info-card.next-billing-date"),value:n.format("YYYY/MM/DD")}]],[e,t,n]);return r(_,{title:t("order.checkout.product-info-card.title"),children:r(s,{container:!0,spacing:1,children:i.map((o,p)=>r(s,{item:!0,xs:12,children:f(s,{container:!0,spacing:2,children:[r(s,{item:!0,xs:4,children:o.label}),r(s,{item:!0,xs:8,children:a?r(M,{variant:"text",width:"100%"}):o.value})]})},p))})})},he=O()((t,{status:e})=>({root:{padding:t.spacing(1)},icon:{fontSize:t.spacing(8),color:t.palette[e===d.FINISHED?"success":"warning"].main}})),me=()=>{const{t}=y(),{status:e}=C(),{classes:a}=he({status:e}),n=l.useMemo(()=>{switch(e){case d.FINISHED:return r(Q,{className:a.icon});case d.CANCELLED:return r(H,{className:a.icon});case d.PENDING:return r(G,{className:a.icon});default:return null}},[e]),i=l.useMemo(()=>{switch(e){case d.FINISHED:return"finished";case d.CANCELLED:return"cancelled";case d.PAID:return"paid";default:return null}},[e]);return r(_,{className:a.root,children:r(N,{direction:"column",spacing:3,children:f(N,{direction:"column",spacing:1,alignItems:"center",children:[n,r(S,{variant:"h3",children:t("order.checkout.status-card.status",{context:i})}),r(S,{variant:"body1",color:"textSecondary",align:"center",children:t("order.checkout.status-card.description",{context:i})})]})})})},pe=()=>{const{t}=y(),[e,{setLeft:a,setRight:n}]=R(!1),{tradeNo:i}=C(),[o]=oe(),{enqueueSnackbar:p}=L(),u=j(async()=>{try{const h=await o(i).unwrap();h?(p(t("notice::order-cancel_success"),{variant:"success"}),I.event("order_cancel",{category:"order",label:"cancel",tradeNo:i,success:!0})):(p(t("notice::order-cancel_failed"),{variant:"error"}),I.event("order_cancel",{category:"order",label:"cancel",tradeNo:i,success:!1,error:h}))}catch(h){console.error("error when cancel order:",h),p(t("notice::order-cancel_failed"),{variant:"error"}),I.event("order_cancel",{category:"order",label:"cancel",tradeNo:i,success:!1,error:h})}a()});return f(B,{children:[r(W,{title:t("order.checkout.order-info-card.cancel-tooltip"),placement:"top",children:r(q,{onClick:n,children:r($,{})})}),f(z,{open:e,onClose:a,children:[r(U,{children:r(N,{direction:"row",alignItems:"center",spacing:1.5,children:r(S,{variant:"inherit",children:t("order.checkout.order-info-card.cancel-dialog.title")})})}),r(Y,{}),r(V,{children:r(J,{children:t("order.checkout.order-info-card.cancel-dialog.content")})}),f(K,{children:[r(E,{onClick:a,children:t("order.checkout.order-info-card.cancel-dialog.cancel-button")}),r(E,{variant:"contained",color:"primary",onClick:u,children:t("order.checkout.order-info-card.cancel-dialog.confirm-button")})]})]})]})},fe=()=>{const{t}=y(),{detail:{data:e,isLoading:a},status:n}=C(),i=l.useMemo(()=>{if(a)return[];const o=(()=>{switch(n){case d.FINISHED:return"finished";case d.CANCELLED:return"cancelled";case d.PENDING:return"pending";case d.PAID:return"paid";default:return"cancelled"}})();return[{label:t("order.checkout.order-info-card.order-number"),value:e==null?void 0:e.trade_no},{label:t("order.checkout.order-info-card.order-date"),value:T.unix((e==null?void 0:e.created_at)||0).format("YYYY-MM-DD HH:mm:ss")},{label:t("order.checkout.order-info-card.order-status"),value:t("order.checkout.order-info-card.order-status-value_".concat(o))},...e!=null&&e.discount_amount?[{label:t("order.checkout.order-info-card.coupon-amount"),value:t("order.checkout.order-info-card.price",{value:(Number((e==null?void 0:e.discount_amount)||0)/100).toFixed(2)})}]:[],...e!=null&&e.surplus_amount?[{label:t("order.checkout.order-info-card.subscription-deduct-amount"),value:t("order.checkout.order-info-card.price",{value:(Number((e==null?void 0:e.surplus_amount)||0)/100).toFixed(2)})}]:[],{label:t("order.checkout.order-info-card.order-amount"),value:t("order.checkout.order-info-card.price",{value:(Number((e==null?void 0:e.total_amount)||0)/100).toFixed(2)})}]},[e,a,n,t]);return a?r(M,{variant:"rectangular",height:200}):r(_,{title:t("order.checkout.order-info-card.title"),secondary:n===d.PENDING&&r(pe,{}),children:r(s,{container:!0,spacing:2,children:i.map((o,p)=>r(s,{item:!0,xs:12,children:f(s,{container:!0,spacing:2,children:[r(s,{item:!0,xs:4,children:o.label}),r(s,{item:!0,xs:8,children:r(S,{variant:"body1",noWrap:!0,children:a?r(M,{variant:"text",width:"100%"}):o.value})})]})},p))})})},be=O()(t=>({icon:{fontSize:t.spacing(2.5)}})),ge=()=>{const{t}=y(),{paymentMethod:{isLoading:e},detail:{isLoading:a},paymentMethodIndex:n,paymentMethodState:i,setPaymentMethodState:o,isSubmitting:p}=C(),u=l.useMemo(()=>Array.from(n.values()),[n]),{classes:h}=be(),b=l.useCallback(({icon:c})=>{switch(!0){case c.includes("alipay"):return r(D,{type:"combined",children:r(X,{className:h.icon})});default:return r(D,{type:"combined",color:"secondary",src:c})}},[]),v=c=>m=>{var g;m.preventDefault(),o(c.id),I.event("select",{category:"order",label:"payment_method",method:(g=n.get(c.id))==null?void 0:g.name,method_id:c.id})};return r(_,{title:t("order.checkout.payment-method-card.title"),content:!1,sx:{"& .MuiCardHeader-title.MuiTypography-subtitle1":{color:"red"}},children:r(Z,{sx:{p:0},children:e||a?Array.from(new Array(3)).map((c,m)=>r(P,{disablePadding:!0,divider:!0,children:r(F,{disabled:!0,children:r(A,{children:r(M,{variant:"text",width:100})})})},m)):u.map(c=>r(P,{disablePadding:!0,divider:!0,children:f(F,{selected:i===c.id,disabled:p,onClick:v(c),onTouchEnd:v(c),sx:{backgroundColor:i===c.id?"#3366FF":"transparent","&.Mui-selected":{backgroundColor:"#3366FF",color:"white","&:hover":{backgroundColor:"#3366FF"}},"&:hover":{backgroundColor:i!==c.id?"#f1f1f1":void 0}},children:[c.icon&&r(ee,{children:r(b,{icon:c.icon})}),r(A,{children:c.name})]})},c.id))})})},ke=()=>{const{t}=y(),{detail:{data:e,isLoading:a},paymentMethodState:n,paymentMethodIndex:i,setSubmitting:o,isSubmitting:p}=C(),[u]=ae(),{enqueueSnackbar:h}=L(),b=l.useMemo(()=>{var c,m,g,k;return[{label:e==null?void 0:e.plan.name,value:t("order.checkout.billing-card.price",{value:Number(((c=e==null?void 0:e.plan[e==null?void 0:e.period])!=null?c:0)/100).toFixed(2)})},...e!=null&&e.discount_amount||e!=null&&e.surplus_amount?[{label:t("order.checkout.billing-card.deduction"),value:t("order.checkout.billing-card.price",{value:((((m=e==null?void 0:e.discount_amount)!=null?m:0)+((g=e==null?void 0:e.surplus_amount)!=null?g:0))/-100).toFixed(2)})}]:[],{label:t("order.checkout.billing-card.total-price"),value:t("order.checkout.billing-card.price",{value:Number(((k=e==null?void 0:e.total_amount)!=null?k:0)/100).toFixed(2)})}]},[e,t]),v=l.useCallback(async c=>{var m,g;if(c.preventDefault(),e&&n)try{o(!0),I.event("click",{category:"order",label:"checkout",method:(m=i.get(n))==null?void 0:m.name,method_id:n}),window.location.href=await u({trade_no:e.trade_no,method:n}).unwrap()}catch(k){console.error(k),h(t("notice::checkout-failed"),{variant:"error"}),I.event("click",{category:"order",label:"checkout",method:(g=i.get(n))==null?void 0:g.name,method_id:n,success:!1,error:k})}finally{o(!1)}else h(t("notice::data-not-loaded"),{variant:"error"})},[u,e,n]);return r(_,{title:t("order.checkout.billing-card.title"),children:f(N,{spacing:2,divider:r(Y,{}),children:[b.map((c,m)=>a?r(M,{variant:"text",width:"100%",height:40},m):f(N,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[r(S,{variant:"body1",children:c.label}),r(S,{variant:"body1",children:c.value})]},m)),r(E,{fullWidth:!0,variant:"contained",disabled:a||p,onClick:v,children:t("order.checkout.billing-card.button")})]})})},ve=()=>{const{status:t}=C();return f(s,{container:!0,spacing:2,children:[r(s,{item:!0,xs:12,children:f(s,{container:!0,spacing:2,children:[t!==d.PENDING&&r(s,{item:!0,xs:12,children:r(me,{})}),r(s,{item:!0,xs:12,md:6,children:r(ue,{})}),r(s,{item:!0,xs:12,md:6,children:r(fe,{})})]})}),t===d.PENDING&&r(s,{item:!0,xs:12,children:f(s,{container:!0,spacing:2,children:[r(s,{item:!0,xs:12,children:r(ge,{})}),r(s,{item:!0,xs:12,children:r(ke,{})})]})})]})},Me=()=>{ie("checkout");const t=re().id;return r(le,{tradeNo:t||"",children:r(ve,{})})};export{Me as default};
